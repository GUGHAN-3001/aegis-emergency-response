<!-- File: frontend_citizen/citizen_app.html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aegis Citizen App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; -webkit-user-select: none; user-select: none; }
        .mobile-screen { width: 100%; max-width: 420px; height: 100vh; max-height: 900px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .sos-button { box-shadow: 0 0 25px rgba(239, 68, 68, 0.5); transition: transform 0.1s; }
        .sos-button:active { transform: scale(0.95); }
        .alert-type-button { transition: background-color 0.2s, transform 0.1s; }
        .alert-type-button:active { transform: scale(0.97); background-color: #374151; }
        .risk-high { color: #ef4444; } .risk-medium { color: #f97316; } .risk-low { color: #22c55e; }
        .form-input { background-color: #374151; border: 1px solid #4b5563; }
        .form-select {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%239ca3af' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            appearance: none;
        }
        #map {
            height: 100%;
            width: 100%;
        }
    </style>
</head>
<body class="bg-gray-800 flex items-center justify-center h-screen">

    <div class="mobile-screen bg-gray-900 text-white flex flex-col overflow-hidden rounded-3xl border-4 border-gray-700">

        <div id="login-screen" class="flex flex-col h-full p-8 justify-center">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-bold">Welcome Back</h1>
                <p class="text-gray-400 mt-2">Log in to your Aegis account.</p>
            </div>
            <div class="space-y-4">
                <input id="login-phone" type="tel" placeholder="Phone Number" class="form-input w-full p-4 rounded-lg text-lg">
                <input id="login-password" type="password" placeholder="Password" class="form-input w-full p-4 rounded-lg text-lg">
            </div>
            <button id="login-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-lg mt-8 text-lg">Log In</button>
            <p class="text-center text-sm text-gray-400 mt-6">
                Don't have an account? <button id="go-to-register-btn" class="font-semibold text-blue-400 hover:underline">Register here</button>
            </p>
        </div>

        <div id="register-screen" class="hidden flex-col h-full p-8 justify-center">
            <div class="text-center mb-10">
                <h1 class="text-4xl font-bold">Create Account</h1>
                <p class="text-gray-400 mt-2">Your safety is our priority.</p>
            </div>
            <div class="space-y-4">
                <input id="reg-name" type="text" placeholder="Full Name" class="form-input w-full p-3 rounded-lg">
                <input id="reg-phone" type="tel" placeholder="Phone Number" class="form-input w-full p-3 rounded-lg">
                <input id="reg-password" type="password" placeholder="Password" class="form-input w-full p-3 rounded-lg">
                <select id="reg-vulnerability" class="form-input form-select w-full p-3 rounded-lg">
                    <option value="NONE">Vulnerability Status (None)</option>
                    <option value="WHEELCHAIR">Wheelchair User</option>
                    <option value="ELDERLY">Elderly</option>
                </select>
            </div>
            <button id="register-btn" class="w-full bg-blue-600 hover:bg-blue-700 font-bold py-3 rounded-lg mt-8">Register</button>
            <p class="text-center text-sm text-gray-400 mt-6">
                Have an account? <button id="go-to-login-btn" class="font-semibold text-blue-400 hover:underline">Log In</button>
            </p>
        </div>

        <div id="home-screen" class="hidden flex-col h-full">
            <header class="p-4 flex justify-between items-center bg-gray-900 z-10">
                <div><h1 class="text-xl font-bold">Aegis</h1><p class="text-sm text-gray-400">Safety Assistant</p></div>
                <div id="network-status" class="text-right"><p class="text-sm font-semibold text-green-400">‚óè Online</p></div>
            </header>
            <div class="relative flex-grow">
                <div id="map"></div>
                <div class="absolute top-2 left-1/2 -translate-x-1/2 bg-black bg-opacity-50 backdrop-blur-sm px-4 py-2 rounded-full z-10">
                    <p id="risk-display" class="text-sm font-medium">Risk: <span class="font-bold">...</span></p>
                </div>
            </div>
            <footer class="p-6 bg-gray-900 border-t border-gray-800">
                <p class="text-center text-gray-400 mb-4">In case of emergency, press below.</p>
                <button id="sos-btn" class="sos-button w-24 h-24 bg-red-600 rounded-full flex items-center justify-center mx-auto border-4 border-red-700/50"><span class="text-3xl font-bold">SOS</span></button>
            </footer>
        </div>

        <div id="sos-screen" class="hidden flex-col h-full p-6 bg-gray-900">
            <h2 class="text-2xl font-bold text-center mt-8">What is your emergency?</h2>
            <div class="grid grid-cols-2 gap-4 mt-12 flex-1">
                <button class="alert-type-button bg-gray-800 rounded-2xl flex flex-col items-center justify-center" data-alert-type="FLOOD"><span class="text-5xl">üåä</span><span class="mt-2">Flood</span></button>
                <button class="alert-type-button bg-gray-800 rounded-2xl flex flex-col items-center justify-center" data-alert-type="FIRE"><span class="text-5xl">üî•</span><span class="mt-2">Fire</span></button>
                <button class="alert-type-button bg-gray-800 rounded-2xl flex flex-col items-center justify-center" data-alert-type="MEDICAL"><span class="text-5xl">‚öïÔ∏è</span><span class="mt-2">Medical</span></button>
                <button class="alert-type-button bg-gray-800 rounded-2xl flex flex-col items-center justify-center" data-alert-type="STRUCTURE_COLLAPSE"><span class="text-5xl">üß±</span><span class="mt-2">Collapse</span></button>
            </div>
            <button id="cancel-sos-btn" class="mt-8 text-gray-400">Cancel</button>
        </div>
        
        <div id="confirmation-screen" class="hidden flex-col h-full p-8 bg-gray-900 items-center justify-center text-center">
            <div class="w-24 h-24 bg-green-500 rounded-full flex items-center justify-center animate-pulse"><svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg></div>
            <h2 class="text-3xl font-bold mt-8">Alert Sent</h2>
            <p id="confirmation-message" class="text-gray-300 mt-2 text-lg">Authorities have been notified.</p>
            <button id="back-to-home-btn" class="mt-12 bg-blue-600 hover:bg-blue-700 font-bold py-3 px-8 rounded-full">Done</button>
        </div>
    </div>

    <!-- Google Maps API Script -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD3phEVM-_zOr5lh4xncnPHPeDSiOy3Nvg&callback=initApp" async defer></script>

    <script>
        const API_BASE_URL = "http://127.0.0.1:8000";
        const dom = {
            login: document.getElementById('login-screen'),
            register: document.getElementById('register-screen'),
            home: document.getElementById('home-screen'),
            sos: document.getElementById('sos-screen'),
            confirm: document.getElementById('confirmation-screen'),
            goToRegisterBtn: document.getElementById('go-to-register-btn'),
            goToLoginBtn: document.getElementById('go-to-login-btn'),
            registerBtn: document.getElementById('register-btn'),
            loginBtn: document.getElementById('login-btn'),
            sosBtn: document.getElementById('sos-btn'),
            cancelSosBtn: document.getElementById('cancel-sos-btn'),
            backToHomeBtn: document.getElementById('back-to-home-btn'),
            alertTypeButtons: document.querySelectorAll('.alert-type-button'),
            confirmMsg: document.getElementById('confirmation-message'),
            riskDisplay: document.getElementById('risk-display'),
        };
        const screens = {
    login: document.getElementById("login-screen"),
    register: document.getElementById("register-screen"),
    home: document.getElementById("home-screen"),
    sos: document.getElementById("sos-screen"),
    confirm: document.getElementById("confirmation-screen"),
};

        let map, userMarker, userLocation = { lat: 13.02903308199252,lon:  80.0188468317313 }; // Default to Chennai center

        function initApp() {
            getUserLocation();
            showScreen(screens.login);
        }

        function getUserLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation.lat = position.coords.latitude;
                        userLocation.lon = position.coords.longitude;
                        if (map) updateMapLocation();
                    },
                    (error) => {
                        console.warn(`Geolocation error: ${error.message}`);
                        alert("Could not get your location. Using a default location.");
                        if (map) updateMapLocation();
                    }
                );
            }
        }

        function updateMapLocation() {
            const latLng = { lat: userLocation.lat, lng: userLocation.lon };
            map.setCenter(latLng);
            map.setZoom(15);
            if (userMarker) {
                userMarker.setPosition(latLng);
            } else {
                userMarker = new google.maps.Marker({
                    position: latLng,
                    map: map,
                    title: "Your Location"
                });
            }
            fetchRiskLevel();
        }

        function initializeMap() {
            if (map) return;
            const mapOptions = {
                center: { lat: userLocation.lat, lng: userLocation.lon },
                zoom: 12,
                disableDefaultUI: true,
                styles: [ { elementType: "geometry", stylers: [{ color: "#242f3e" }] }, { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] }, { featureType: "road", elementType: "geometry", stylers: [{ color: "#38414e" }] }, { featureType: "road", elementType: "geometry.stroke", stylers: [{ color: "#212a37" }] }, { featureType: "road", elementType: "labels.text.fill", stylers: [{ color: "#9ca5b3" }] }, { featureType: "road.highway", elementType: "geometry", stylers: [{ color: "#746855" }] }, { featureType: "water", elementType: "geometry", stylers: [{ color: "#17263c" }] } ]
            };
            map = new google.maps.Map(document.getElementById("map"), mapOptions);
            updateMapLocation();
        }

        function showScreen(screen) {
            Object.values(screens).forEach(el => el.classList && el.classList.add('hidden'));
            screen.classList.remove('hidden');
            screen.classList.add('flex');
            if (screen === screens.home) {
                initializeMap();
            }
        }

        dom.goToRegisterBtn.addEventListener('click', () => showScreen(screens.register));
        dom.goToLoginBtn.addEventListener('click', () => showScreen(screens.login));
        dom.sosBtn.addEventListener('click', () => showScreen(screens.sos));
        dom.cancelSosBtn.addEventListener('click', () => showScreen(screens.home));
        dom.backToHomeBtn.addEventListener('click', () => showScreen(screens.home));
        
        dom.registerBtn.addEventListener('click', async () => {
            const payload = {
                full_name: document.getElementById('reg-name').value,
                phone_number: document.getElementById('reg-phone').value,
                password: document.getElementById('reg-password').value,
                vulnerability_status: document.getElementById('reg-vulnerability').value
            };
            if (!payload.full_name || !payload.phone_number || !payload.password) return alert("Please fill all fields.");
            try {
                const res = await fetch(`${API_BASE_URL}/users/register`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!res.ok) throw new Error((await res.json()).detail);
                alert("Registration successful! Please log in.");
                showScreen(screens.login);
            } catch (error) { alert(`Registration Error: ${error.message}`); }
        });
        
        dom.loginBtn.addEventListener('click', async () => {
            const formData = new URLSearchParams({ username: document.getElementById('login-phone').value, password: document.getElementById('login-password').value });
            try {
                const res = await fetch(`${API_BASE_URL}/users/login`, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: formData });
                if (!res.ok) throw new Error((await res.json()).detail);
                const data = await res.json();
                localStorage.setItem('aegis-token', data.access_token);
                showScreen(screens.home);
            } catch (error) { alert(`Login Error: ${error.message}`); }
        });

        dom.alertTypeButtons.forEach(button => button.addEventListener('click', () => {
            sendAlert(button.dataset.alertType);
            showScreen(screens.confirm);
        }));

        async function sendAlert(alertType) {
            const token = localStorage.getItem('aegis-token');
            if (!token) { showScreen(screens.login); return; }
            const payload = { alert_type: alertType, latitude: userLocation.lat, longitude: userLocation.lon };
            try {
                const res = await fetch(`${API_BASE_URL}/alerts`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, body: JSON.stringify(payload) });
                if (res.status === 401) { showScreen(screens.login); return; }
                dom.confirmMsg.textContent = "Authorities have been notified.";
            } catch (error) { dom.confirmMsg.textContent = "No network. Alert queued."; }
        }

        async function fetchRiskLevel() {
            try {
                const res = await fetch(`${API_BASE_URL}/ml/risk?lat=${userLocation.lat}&lon=${userLocation.lon}`);
                if (!res.ok) throw new Error("Could not fetch risk data.");
                const data = await res.json();
                const riskSpan = dom.riskDisplay.querySelector('span');
                riskSpan.textContent = data.risk_level;
                riskSpan.className = `font-bold risk-${data.risk_level.toLowerCase()}`;
            } catch (error) {
                dom.riskDisplay.querySelector('span').textContent = "Unknown";
            }
        }
        getUserLocation();
    </script>
</body>
</html>
